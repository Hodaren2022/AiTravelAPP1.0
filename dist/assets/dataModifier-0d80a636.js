import"./index-3bc619a7.js";class p extends Error{constructor(s,d=null){super(s),this.name="DataModificationError",this.changeId=d}}class w{constructor(){this.changeHistory=[]}async applyChange(s){try{const{type:d,category:i,field:a,newValue:n,oldValue:t,targetId:r}=s;switch(i){case"trip":return await this.modifyTripData(s);case"expense":return await this.modifyExpenseData(s);case"note":return await this.modifyNoteData(s);case"packing":return await this.modifyPackingData(s);case"hotel":return await this.modifyHotelData(s);case"itinerary":return await this.modifyItineraryData(s);default:throw new p(`不支持的數據類型: ${i}`,s.id)}}catch(d){throw console.error("Error applying change:",d),new p(d.message||"應用變更時發生錯誤",s.id)}}async applyChanges(s){const d=[],i=[];for(const a of s)try{const n=await this.applyChange(a);d.push({changeId:a.id,success:!0,result:n}),this.changeHistory.push({...a,appliedAt:new Date,success:!0})}catch(n){i.push({changeId:a.id,error:n.message}),this.changeHistory.push({...a,appliedAt:new Date,success:!1,error:n.message})}return{results:d,errors:i}}async modifyTripData(s){const{type:d,field:i,newValue:a,targetId:n}=s,t=JSON.parse(localStorage.getItem("trips")||"[]");switch(d){case"create":const r={...a,id:a.id||`trip_${Date.now()}`,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return t.push(r),localStorage.setItem("lastSelectedTrip",r.id),localStorage.setItem("trips",JSON.stringify(t)),window.dispatchEvent(new Event("storage")),r;case"edit":case"add":case"delete":let e=-1;if(n)e=t.findIndex(o=>o.id===n);else{const o=localStorage.getItem("lastSelectedTrip");e=t.findIndex(l=>l.id===o)}if(e===-1)throw new p("找不到指定的行程");switch(d){case"edit":t[e][i]=a,t[e].updatedAt=new Date().toISOString();break;case"add":i==="flights"?(t[e].flights=t[e].flights||[],t[e].flights.push(a)):i==="hotels"?(t[e].hotels=t[e].hotels||[],t[e].hotels.push(a)):t[e][i]=a,t[e].updatedAt=new Date().toISOString();break;case"delete":if(i==="flights"||i==="hotels"){const o=t[e][i]||[],l=o.findIndex(c=>c.id===a);l>-1&&o.splice(l,1)}else delete t[e][i];t[e].updatedAt=new Date().toISOString();break}return localStorage.setItem("trips",JSON.stringify(t)),window.dispatchEvent(new Event("storage")),t[e]}}async modifyExpenseData(s){const{type:d,field:i,newValue:a,targetId:n}=s,t=localStorage.getItem("lastSelectedTrip"),r=JSON.parse(localStorage.getItem("expenses")||"{}");if(!t)throw new p("沒有選中的行程");const e=r[t]||[];switch(d){case"add":e.push({id:Date.now().toString(),...a,createdAt:new Date().toISOString()});break;case"edit":const o=e.findIndex(c=>c.id===n);o>-1&&(e[o][i]=a);break;case"delete":const l=e.findIndex(c=>c.id===n);l>-1&&e.splice(l,1);break}return r[t]=e,localStorage.setItem("expenses",JSON.stringify(r)),window.dispatchEvent(new Event("storage")),e}async modifyNoteData(s){const{type:d,field:i,newValue:a,targetId:n}=s,t=JSON.parse(localStorage.getItem("notes")||"[]");switch(d){case"add":t.push({id:Date.now().toString(),...a,createdAt:new Date().toISOString()});break;case"edit":const r=t.findIndex(o=>o.id===n);r>-1&&(t[r][i]=a);break;case"delete":const e=t.findIndex(o=>o.id===n);e>-1&&t.splice(e,1);break}return localStorage.setItem("notes",JSON.stringify(t)),window.dispatchEvent(new Event("storage")),t}async modifyPackingData(s){const{type:d,field:i,newValue:a,targetId:n}=s,t=localStorage.getItem("lastSelectedTrip"),r=JSON.parse(localStorage.getItem("packingLists")||"{}");if(!t)throw new p("沒有選中的行程");const e=r[t]||[];switch(d){case"add":e.push({id:Date.now().toString(),...a,createdAt:new Date().toISOString()});break;case"edit":const o=e.findIndex(c=>c.id===n);o>-1&&(e[o][i]=a);break;case"delete":const l=e.findIndex(c=>c.id===n);l>-1&&e.splice(l,1);break}return r[t]=e,localStorage.setItem("packingLists",JSON.stringify(r)),window.dispatchEvent(new Event("storage")),e}async modifyHotelData(s){const{type:d,field:i,newValue:a,targetId:n}=s,t=localStorage.getItem("lastSelectedTrip"),r=JSON.parse(localStorage.getItem("hotels")||"{}");if(!t)throw new p("沒有選中的行程");const e=r[t]||[];switch(d){case"add":e.push({id:Date.now().toString(),...a,createdAt:new Date().toISOString()});break;case"edit":const o=e.findIndex(c=>c.id===n);o>-1&&(e[o][i]=a);break;case"delete":const l=e.findIndex(c=>c.id===n);l>-1&&e.splice(l,1);break}return r[t]=e,localStorage.setItem("hotels",JSON.stringify(r)),window.dispatchEvent(new Event("storage")),e}async modifyItineraryData(s){const{type:d,field:i,newValue:a,targetId:n}=s,t=localStorage.getItem("lastSelectedTrip"),r=JSON.parse(localStorage.getItem("itineraries")||"{}");if(!t)throw new p("沒有選中的行程");const e=r[t]||[];switch(d){case"add":e.push({id:Date.now().toString(),...a,createdAt:new Date().toISOString()});break;case"edit":const o=e.findIndex(c=>c.id===n);o>-1&&(e[o][i]=a);break;case"delete":const l=e.findIndex(c=>c.id===n);l>-1&&e.splice(l,1);break}return r[t]=e,localStorage.setItem("itineraries",JSON.stringify(r)),window.dispatchEvent(new Event("storage")),e}getChangeHistory(){return this.changeHistory}clearHistory(){this.changeHistory=[]}}const I=new w;export{p as DataModificationError,I as dataModifier,I as default};
