import"./index-c899618d.js";class p extends Error{constructor(i,o=null){super(i),this.name="DataModificationError",this.changeId=o}}class f{constructor(){this.changeHistory=[]}async applyChange(i){try{const{type:o,category:n,field:s,newValue:r,oldValue:t,targetId:a}=i;switch(n){case"trip":return await this.modifyTripData(i);case"expense":return await this.modifyExpenseData(i);case"note":return await this.modifyNoteData(i);case"packing":return await this.modifyPackingData(i);case"hotel":return await this.modifyHotelData(i);case"itinerary":return await this.modifyItineraryData(i);default:throw new p(`不支持的數據類型: ${n}`,i.id)}}catch(o){throw console.error("Error applying change:",o),new p(o.message||"應用變更時發生錯誤",i.id)}}async applyChanges(i){const o=[],n=[];for(const s of i)try{const r=await this.applyChange(s);o.push({changeId:s.id,success:!0,result:r}),this.changeHistory.push({...s,appliedAt:new Date,success:!0})}catch(r){n.push({changeId:s.id,error:r.message}),this.changeHistory.push({...s,appliedAt:new Date,success:!1,error:r.message})}return{results:o,errors:n}}async modifyTripData(i){const{type:o,field:n,newValue:s,targetId:r}=i,t=JSON.parse(localStorage.getItem("trips")||"[]");let a=-1;if(r)a=t.findIndex(e=>e.id===r);else{const e=localStorage.getItem("lastSelectedTrip");a=t.findIndex(d=>d.id===e)}if(a===-1)throw new p("找不到指定的行程");switch(o){case"edit":t[a][n]=s;break;case"add":n==="flights"?(t[a].flights=t[a].flights||[],t[a].flights.push(s)):n==="hotels"?(t[a].hotels=t[a].hotels||[],t[a].hotels.push(s)):t[a][n]=s;break;case"delete":if(n==="flights"||n==="hotels"){const e=t[a][n]||[],d=e.findIndex(l=>l.id===s);d>-1&&e.splice(d,1)}else delete t[a][n];break}return localStorage.setItem("trips",JSON.stringify(t)),window.dispatchEvent(new Event("storage")),t[a]}async modifyExpenseData(i){const{type:o,field:n,newValue:s,targetId:r}=i,t=localStorage.getItem("lastSelectedTrip"),a=JSON.parse(localStorage.getItem("expenses")||"{}");if(!t)throw new p("沒有選中的行程");const e=a[t]||[];switch(o){case"add":e.push({id:Date.now().toString(),...s,createdAt:new Date().toISOString()});break;case"edit":const d=e.findIndex(c=>c.id===r);d>-1&&(e[d][n]=s);break;case"delete":const l=e.findIndex(c=>c.id===r);l>-1&&e.splice(l,1);break}return a[t]=e,localStorage.setItem("expenses",JSON.stringify(a)),window.dispatchEvent(new Event("storage")),e}async modifyNoteData(i){const{type:o,field:n,newValue:s,targetId:r}=i,t=JSON.parse(localStorage.getItem("notes")||"[]");switch(o){case"add":t.push({id:Date.now().toString(),...s,createdAt:new Date().toISOString()});break;case"edit":const a=t.findIndex(d=>d.id===r);a>-1&&(t[a][n]=s);break;case"delete":const e=t.findIndex(d=>d.id===r);e>-1&&t.splice(e,1);break}return localStorage.setItem("notes",JSON.stringify(t)),window.dispatchEvent(new Event("storage")),t}async modifyPackingData(i){const{type:o,field:n,newValue:s,targetId:r}=i,t=localStorage.getItem("lastSelectedTrip"),a=JSON.parse(localStorage.getItem("packingLists")||"{}");if(!t)throw new p("沒有選中的行程");const e=a[t]||[];switch(o){case"add":e.push({id:Date.now().toString(),...s,createdAt:new Date().toISOString()});break;case"edit":const d=e.findIndex(c=>c.id===r);d>-1&&(e[d][n]=s);break;case"delete":const l=e.findIndex(c=>c.id===r);l>-1&&e.splice(l,1);break}return a[t]=e,localStorage.setItem("packingLists",JSON.stringify(a)),window.dispatchEvent(new Event("storage")),e}async modifyHotelData(i){const{type:o,field:n,newValue:s,targetId:r}=i,t=localStorage.getItem("lastSelectedTrip"),a=JSON.parse(localStorage.getItem("hotels")||"{}");if(!t)throw new p("沒有選中的行程");const e=a[t]||[];switch(o){case"add":e.push({id:Date.now().toString(),...s,createdAt:new Date().toISOString()});break;case"edit":const d=e.findIndex(c=>c.id===r);d>-1&&(e[d][n]=s);break;case"delete":const l=e.findIndex(c=>c.id===r);l>-1&&e.splice(l,1);break}return a[t]=e,localStorage.setItem("hotels",JSON.stringify(a)),window.dispatchEvent(new Event("storage")),e}async modifyItineraryData(i){const{type:o,field:n,newValue:s,targetId:r}=i,t=localStorage.getItem("lastSelectedTrip"),a=JSON.parse(localStorage.getItem("itineraries")||"{}");if(!t)throw new p("沒有選中的行程");const e=a[t]||[];switch(o){case"add":e.push({id:Date.now().toString(),...s,createdAt:new Date().toISOString()});break;case"edit":const d=e.findIndex(c=>c.id===r);d>-1&&(e[d][n]=s);break;case"delete":const l=e.findIndex(c=>c.id===r);l>-1&&e.splice(l,1);break}return a[t]=e,localStorage.setItem("itineraries",JSON.stringify(a)),window.dispatchEvent(new Event("storage")),e}getChangeHistory(){return this.changeHistory}clearHistory(){this.changeHistory=[]}}const w=new f;export{p as DataModificationError,w as dataModifier,w as default};
